ARG VPP_DEV_IMAGE_BASE=quay.io/travelping/fpp-vpp:v24.02.7_dev_release
FROM ${VPP_DEV_IMAGE_BASE}

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# ----------------------------
# Install development tools
# ----------------------------
RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    clang-format \
    git \
    meson \
    ninja-build \
    python3 \
    python3-pip \
    libffi-dev \
    pkg-config \
    cmake \
    wget \
    curl \
    bash-completion \
    ca-certificates \
    libhyperscan-dev \
 && rm -rf /var/lib/apt/lists/*

# Enable bash completion
RUN echo "if [ -f /etc/bash_completion ]; then . /etc/bash_completion; fi" >> /etc/bash.bashrc

# ----------------------------
# Create non-root user
# ----------------------------
ARG USER=dev
ARG UID=1000
ARG GID=1000
RUN groupadd -g ${GID} ${USER} \
 && useradd -m -u ${UID} -g ${GID} -s /bin/bash ${USER}


# -----------------------------------
# Setup ccache for the non-root user
# -----------------------------------
RUN mkdir -p /home/dev/.ccache \
    && chown -R dev:dev /home/dev/.ccache

ENV CCACHE_DIR=/home/dev/.ccache
ENV CCACHE_MAXSIZE=1G

# ----------------------------
# Workspace directory
# ----------------------------
RUN mkdir -p /home/${USER}/workspace \
 && chown -R ${USER}:${USER} /home/${USER}/workspace

WORKDIR /home/${USER}/workspace
USER ${USER}

# ----------------------------
# Keep container running
# ----------------------------
ENTRYPOINT ["tail", "-f", "/dev/null"]
